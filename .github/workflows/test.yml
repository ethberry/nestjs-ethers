name: CI Test

on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22.x]
    services:
       besu:
         image: hyperledger/besu:latest
         env:
           BESU_GENESIS_FILE: /var/lib/besu/gen-besu.json
           BESU_DATA_PATH: /var/lib/besu
           BESU_HOST_ALLOWLIST: "*"
           BESU_RPC_WS_ENABLED: "true"
           BESU_RPC_WS_HOST: 0.0.0.0
           BESU_RPC_HTTP_HOST: 0.0.0.0
           BESU_RPC_HTTP_ENABLED: "true"
           BESU_RPC_HTTP_CORS_ORIGINS: "*"
           BESU_RPC_HTTP_API: "ADMIN,ETH,NET,WEB3,MINER,IBFT"
           BESU_RPC_WS_API: "ADMIN,ETH,NET,WEB3,MINER,IBFT"
           BESU_MINER_ENABLED: "true"
           BESU_MINER_COINBASE: fe3b557e8fb62b89f4916b721be55ceb828dbd73
         volumes:
           - ${{ github.workspace }}/besu:/var/lib/besu
           - ${{ github.workspace }}/gen-besu.json:/var/lib/besu/gen-besu.json
         ports:
           - "8545:8545"
           - "8546:8546"
           - "8547:8547"
           - "30303:30303"
       explorer:
         image: alethio/ethereum-lite-explorer
         env:
           APP_NODE_URL: "http://127.0.0.1:8545"
         ports:
           - 8080:80

    steps:
      - uses: actions/checkout@v4
        name: Checkout code
      - uses: actions/setup-node@v4
        name: Use Node.js ${{ matrix.node-version }}
        with:
          node-version: ${{ matrix.node-version }}
      - name: npm install
        run: npm i
      - name: check lint
        run: npm run lint
      - name: npm test
        run: npm run test
