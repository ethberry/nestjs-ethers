name: CI Test on PR

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - dev

jobs:
  test:
    if: ${{ !contains(github.head_ref, 'renovate') }}
    runs-on: ubuntu-latest
    env:
      BESU_GENESIS_FILE: /var/lib/besu/gen-besu.json
      #          BESU_DATA_PATH: /var/lib/besu
      BESU_HOST_ALLOWLIST: "*"
      BESU_RPC_WS_ENABLED: "true"
      BESU_RPC_WS_HOST: 0.0.0.0
      BESU_RPC_HTTP_HOST: 0.0.0.0
      BESU_RPC_HTTP_ENABLED: "true"
      BESU_RPC_HTTP_CORS_ORIGINS: "*"
      BESU_RPC_HTTP_API: "ETH,NET,WEB3,MINER"
      BESU_RPC_WS_API: "ETH,NET,WEB3,MINER"
      BESU_MINER_ENABLED: "true"
      BESU_MINER_COINBASE: fe3b557e8fb62b89f4916b721be55ceb828dbd73
    services:
      besu:
        # Docker Hub image
        image: hyperledger/besu:latest
        # Provide the besu setup
        env:
          BESU_GENESIS_FILE: /var/lib/besu/gen-besu.json
#          BESU_DATA_PATH: /var/lib/besu
          BESU_HOST_ALLOWLIST: "*"
          BESU_RPC_WS_ENABLED: "true"
          BESU_RPC_WS_HOST: 0.0.0.0
          BESU_RPC_HTTP_HOST: 0.0.0.0
          BESU_RPC_HTTP_ENABLED: "true"
          BESU_RPC_HTTP_CORS_ORIGINS: "*"
          BESU_RPC_HTTP_API: "ETH,NET,WEB3,MINER"
          BESU_RPC_WS_API: "ETH,NET,WEB3,MINER"
          BESU_MINER_ENABLED: "true"
          BESU_MINER_COINBASE: fe3b557e8fb62b89f4916b721be55ceb828dbd73
        volumes:
            - ${{ github.workspace }}/besu/gen-besu.json:/var/lib/besu/gen-besu.json
        ports:
          - "9201:8545"
          - "9202:8546"
          - "9203:8547"
          - "9204:30303"
        options: -v ${{ github.workspace }}/besu/gen-besu.json:/var/lib/besu/gen-besu.json --health-cmd "ping 0.0.0.0" --health-start-period 30s --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }}

      - name: Add @scope & token to npmrc
        run: |
          echo "@gemunion:registry=https://npm.pkg.github.com/" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=$GITHUBTOKEN" >> .npmrc
        env:
          GITHUBTOKEN: ${{ secrets.GITHUBTOKEN }}


      - name: Authenticate check via npm
        run: npm whoami --registry=https://npm.pkg.github.com/

      - name: Install & Build Packages
        run: npm i && npm run build

      - name: Npm run test
#        run: bash -c 'while [[ "$$(curl --connect-timeout 2 -s -o /dev/null -w ''%{http_code}'' http://localhost:9201)" != "201" ]]; do echo ..; sleep 5; done; echo besu is up; npm run test'
        run: npm run test

